name: Test Braver Script

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Test print-only (URL selection)
        run: |
          URL=$(python3 braver.py --print-only)
          echo "Selected URL: $URL"
          if [[ -z "$URL" ]] || [[ ! "$URL" =~ ^https://.*github.* ]]; then
            echo "ERROR: Invalid URL returned"
            exit 1
          fi

      - name: Test download
        run: |
          python3 braver.py --dir ./test-downloads
          FILE=$(ls ./test-downloads/*.deb | head -n 1)
          if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then
            echo "ERROR: Download file not found"
            exit 1
          fi
          SIZE=$(stat -c%s "$FILE")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: File too small ($SIZE bytes)"
            exit 1
          fi
          echo "Download successful: $FILE ($SIZE bytes)"

      - name: Cleanup
        if: always()
        run: rm -rf ./test-downloads

  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Test print-only (URL selection)
        run: |
          URL=$(python3 braver.py --print-only)
          echo "Selected URL: $URL"
          if [[ -z "$URL" ]] || [[ ! "$URL" =~ ^https://.*github.* ]]; then
            echo "ERROR: Invalid URL returned"
            exit 1
          fi

      - name: Test download
        run: |
          python3 braver.py --dir ./test-downloads
          FILE=$(ls ./test-downloads/*.dmg ./test-downloads/*.pkg 2>/dev/null | head -n 1)
          if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then
            echo "ERROR: Download file not found"
            exit 1
          fi
          SIZE=$(stat -f%z "$FILE")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "ERROR: File too small ($SIZE bytes)"
            exit 1
          fi
          echo "Download successful: $FILE ($SIZE bytes)"

      - name: Cleanup
        if: always()
        run: |
          rm -rf ./test-downloads
          hdiutil detach /Volumes/BraveTmpMount 2>/dev/null || true

  test-windows:
    name: Test on Windows
    runs-on: windows-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Test print-only (URL selection)
        run: |
          $URL = python braver.py --print-only
          Write-Host "Selected URL: $URL"
          if ([string]::IsNullOrEmpty($URL) -or $URL -notmatch "^https://.*github.*") {
            Write-Host "ERROR: Invalid URL returned"
            exit 1
          }

      - name: Test download
        run: |
          python braver.py --dir ./test-downloads
          $file = Get-ChildItem ./test-downloads/*.exe | Select-Object -First 1
          if ($null -eq $file) {
            Write-Host "ERROR: Download file not found"
            exit 1
          }
          $size = $file.Length
          if ($size -lt 1000000) {
            Write-Host "ERROR: File too small ($size bytes)"
            exit 1
          }
          Write-Host "Download successful: $($file.Name) ($size bytes)"

      - name: Cleanup
        if: always()
        run: Remove-Item -Recurse -Force ./test-downloads -ErrorAction SilentlyContinue

